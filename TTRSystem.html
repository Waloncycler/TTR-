<html><head><base href="/" />
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>唐肽燃管理系统</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.3/build/global/luxon.min.js"></script>
<script src='https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js'></script>
<link rel="stylesheet" href="systemstyles.css">
</head>
<body>

<div id="loginPage" class="login-container">
  <div class="login-box">
    <h1>唐肽燃管理系统</h1>
    <form id="loginForm" onsubmit="handleLogin(event)">
      <div class="form-group">
        <label>用户名</label>
        <input type="text" id="username" class="form-control" required>
      </div>
      <div class="form-group">
        <label>密码</label>
        <input type="password" id="password" class="form-control" required>
      </div>
      <button type="submit" class="btn btn-primary" style="width: 100%;">登录</button>
    </form>
  </div>
</div>

<div class="container" style="display: none;">
  <div class="sidebar">
    <h1>唐肽燃管理系统</h1>
    
    <div class="nav-section">
      <h2>财务管理系统</h2>
      <div class="nav-item" onclick="showDashboard()">财务概览</div>
      <div class="nav-item" onclick="showTransactions()">账单管理</div>
      <div class="nav-item" onclick="showBudget()">预算管理</div>
    </div>

    <div class="nav-section">
      <h2>货物信息管理系统</h2>
      <div class="nav-item" onclick="showLogistics()">物流信息</div>
      <div class="nav-item" onclick="showInventory()">库存管理</div>
    </div>
    
    <div class="nav-section">
      <div class="nav-item" onclick="logout()">退出登录</div>
    </div>
  </div>
  
  <div class="main-content">
    <div id="dashboard">
      <h2>财务概览</h2>
      
      <!-- 时间段选择器 -->
      <div class="time-filter card" style="margin-bottom: 1.5rem;">
        <select id="timeRangeFilter" class="form-control" onchange="updateDashboard()" style="width: auto;">
          <option value="month">月度数据</option>
          <option value="quarter">季度数据</option>
          <option value="year">年度数据</option>
        </select>
      </div>

      <div class="dashboard">
        <div class="card stat-card" onclick="showAssetDistribution()">
          <h3>总资产</h3>
          <div class="stat-value" id="totalAssets">¥128,500</div>
          <div class="stat-change" id="assetChange">+3.2% ↑</div>
        </div>
        <div class="card stat-card" onclick="showExpenseDetails()">
          <h3>支出</h3>
          <div class="stat-value" id="totalExpense">¥15,200</div>
          <div class="stat-change" id="expenseChange">-2.1% ↓</div>
        </div>
        <div class="card stat-card" onclick="showIncomeDetails()">
          <h3>收入</h3>
          <div class="stat-value" id="totalIncome">¥25,800</div>
          <div class="stat-change" id="incomeChange">+5.4% ↑</div>
        </div>
        <div class="card stat-card">
          <h3>结余</h3>
          <div class="stat-value" id="netIncome">¥10,600</div>
          <div class="stat-change" id="netIncomeChange">+8.3% ↑</div>
        </div>
      </div>
      
      <div class="dashboard-charts" style="margin-top: 1.5rem;">
        <div class="card chart-container">
          <canvas id="trendChart"></canvas>
        </div>
      </div>
    </div>

    <div id="transactions" class="transactions-container">
      <div class="transaction-summary"></div>
      <div class="transaction-form card">
        <div class="collapsible-section">
          <div class="collapsible-header" onclick="toggleCollapsibleContent(this)">
            <span>添加新账单</span>
            <span>+</span>
          </div>
          <div class="collapsible-content">
            <form id="newTransactionForm" onsubmit="handleAddTransaction(event)">
              <div class="form-group">
                <label>类型</label>
                <select class="form-control" id="transactionType" required onchange="updateCategoryOptions()">
                  <option value="income">收入</option>
                  <option value="expense">支出</option>
                </select>
              </div>
              <div class="form-group">
                <label>金额</label>
                <input type="number" class="form-control" id="transactionAmount" required min="0" step="0.01">
              </div>
              <div class="form-group">
                <label>类别</label>
                <select class="form-control" id="transactionCategory" required>
                  <option value="salary">工资</option>
                  <option value="offline">线下订单</option>
                  <option value="online">线上订单</option>
                  <option value="transportation">交通</option>
                  <option value="purchase">进货</option>
                  <option value="other">其他</option>
                </select>
              </div>
              <div class="form-group">
                <label>日期</label>
                <input type="date" class="form-control" id="transactionDate" required>
              </div>
              <div class="form-group">
                <label>备注</label>
                <textarea class="form-control" id="transactionNote"></textarea>
              </div>
              <button type="submit" class="btn btn-primary">添加交易</button>
            </form>
          </div>
        </div>
      </div>

      <div class="transaction-filters card" style="margin-bottom: 1.5rem;">
        <div style="display: flex; gap: 1rem; align-items: center;">
          <div class="form-group" style="margin-bottom: 0;">
            <label>开始日期</label>
            <input type="date" class="form-control" id="filterStartDate">
          </div>
          <div class="form-group" style="margin-bottom: 0;">
            <label>结束日期</label>
            <input type="date" class="form-control" id="filterEndDate">
          </div>
          <button class="btn btn-primary" onclick="filterTransactions()" style="margin-top: 1.5rem;">查询</button>
          <button class="btn btn-warning" onclick="resetFilters()" style="margin-top: 1.5rem;">重置</button>
        </div>
      </div>

      <div class="transactions-list card">
        <div class="transaction-item" style="font-weight: bold;">
          <div>日期</div>
          <div>类型</div>
          <div>类别</div>
          <div>金额</div>
          <div>操作</div>
        </div>
        <div id="transactionsList"></div>
      </div>
    </div>

    <div id="budget" class="budget-container">
      <h2>预算管理</h2>
      
      <div class="budget-overview">
        <div class="card stat-card">
          <h3>本月预算总额</h3>
          <div class="stat-value" id="totalBudget">¥20,000</div>
        </div>
        <div class="card stat-card">
          <h3>已使用</h3>
          <div class="stat-value" id="usedBudget">¥12,500</div>
        </div>
        <div class="card stat-card">
          <h3>剩余预算</h3>
          <div class="stat-value" id="remainingBudget">¥7,500</div>
        </div>
      </div>

      <div class="card">
        <h3>设置预算</h3>
        <form id="budgetForm" onsubmit="handleAddBudget(event)">
          <div class="form-group">
            <label>类别</label>
            <select class="form-control" id="budgetCategory" required>
              <option value="online">线上订单</option>
              <option value="transportation">交通</option>
              <option value="purchase">进货</option>
              <option value="other">其他</option>
            </select>
          </div>
          <div class="form-group">
            <label>金额</label>
            <input type="number" class="form-control" id="budgetAmount" required min="0" step="0.01">
          </div>
          <button type="submit" class="btn btn-primary">设置预算</button>
        </form>
      </div>

      <div class="card" style="margin-top: 2rem;">
        <h3>预算使用情况</h3>
        <div id="budgetList"></div>
      </div>
    </div>

    <div id="logistics" style="display: none;">
      <h2>物流信息</h2>

      <!-- Add the collapsible form here, before the cards -->
      <div class="collapsible-section">
        <div class="collapsible-header" onclick="toggleCollapsibleContent(this)">
          <span>添加物流信息</span>
          <span>+</span>
        </div>
        <div class="collapsible-content">
          <form id="logisticsForm" onsubmit="handleAddLogistics(event)">
            <div class="form-group">
              <label>物流公司</label>
              <select class="form-control" id="logisticsCompany" required>
                <option value="">请选择物流公司</option>
                <option value="SF">顺丰快递</option>
                <option value="YT">圆通快递</option>
                <option value="ZT">中通快递</option>
                <option value="YD">韵达快递</option>
                <option value="ST">申通快递</option>
                <option value="EMS">EMS</option>
                <option value="JD">京东快递</option>
              </select>
            </div>
            <div class="form-group">
              <label>快递单图片识别</label>
              <div style="display: flex; gap: 1rem; align-items: center;">
                <input type="file" accept="image/*" class="form-control" id="logisticsImage" onchange="handleImageUpload(event)">
                <button type="button" class="btn btn-primary" onclick="recognizeLogistics()">识别信息</button>
              </div>
              <div id="previewContainer" style="margin-top: 10px; max-width: 300px;"></div>
            </div>
            <div class="form-group">
              <label>物流单号</label>
              <input type="text" class="form-control" id="orderNumber" required>
            </div>
            <div class="form-group">
              <label>产品名称</label>
              <input type="text" class="form-control" id="logisticsProduct" required>
            </div>
            <div class="form-group">
              <label>数量</label>
              <input type="number" class="form-control" id="logisticsQuantity" required min="1">
            </div>
            <div class="form-group">
              <label>状态</label>
              <select class="form-control" id="logisticsStatus" required>
                <option value="pending">待发货</option>
                <option value="transit">运输中</option>
                <option value="delivered">已送达</option>
              </select>
            </div>
            <div class="form-group">
              <label>收件人</label>
              <input type="text" class="form-control" id="logisticsRecipient" required>
            </div>
            <div class="form-group">
              <label>联系方式</label>
              <input type="text" class="form-control" id="logisticsContact" required>
            </div>
            <div class="form-group large">
              <label>收货地址</label>
              <input type="text" class="form-control" id="logisticsAddress" required>
            </div>
            <div class="form-group">
              <label>日期</label>
              <input type="date" class="form-control" id="logisticsDate" required>
            </div>
            <button type="submit" class="btn btn-primary" style="margin-top: 1rem;">添加物流信息</button>
          </form>
        </div>
      </div>

      <div class="card" style="margin-top: 1.5rem;">
        <h3>待发货订单</h3>
        <div class="logistics-list" id="pendingShipments">
          <!-- Shipping items will be populated here -->
        </div>
      </div>

      <div class="card" style="margin-top: 1.5rem;">
        <h3>在途订单</h3>
        <div class="logistics-list" id="inTransitShipments">
          <!-- In-transit items will be populated here -->
        </div>
      </div>

      <div class="card" style="margin-top: 1.5rem;">
        <h3>已送达订单</h3>
        <div class="logistics-list" id="deliveredShipments">
          <!-- Delivered items will be populated here -->
        </div>
      </div>
    </div>

    <div id="inventory" style="display: none;">
      <h2>库存管理</h2>
      <div class="card">
        <div class="collapsible-section">
          <div class="collapsible-header" onclick="toggleCollapsibleContent(this)">
            <span>添加库存</span>
            <span>+</span>
          </div>
          <div class="collapsible-content">
            <form id="inventoryForm" onsubmit="handleAddInventory(event)">
              <div class="form-group">
                <label>商品名称</label>
                <input type="text" class="form-control" id="productName" required>
              </div>
              <div class="form-group">
                <label>数量</label>
                <input type="number" class="form-control" id="quantity" required min="0">
              </div>
              <div class="form-group">
                <label>单位</label>
                <input type="text" class="form-control" id="unit" required>
              </div>
              <div class="form-group">
                <label>存储位置</label>
                <input type="text" class="form-control" id="location" required>
              </div>
              <button type="submit" class="btn btn-primary">添加</button>
            </form>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top: 1.5rem;">
        <h3>库存列表</h3>
        <div class="inventory-list" id="inventoryList">
          <!-- Inventory items will be populated here -->
        </div>
      </div>
    </div>

    <!-- Add Transaction Edit Modal -->
    <div id="editTransactionModal" class="modal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeEditModal()">&times;</span>
        <h3>编辑交易</h3>
        <form id="editTransactionForm" onsubmit="handleEditTransaction(event)">
          <div class="form-group">
            <label>类型</label>
            <select class="form-control" id="editTransactionType" required onchange="updateEditCategoryOptions()">
              <option value="income">收入</option>
              <option value="expense">支出</option>
            </select>
          </div>
          <div class="form-group">
            <label>金额</label>
            <input type="number" class="form-control" id="editTransactionAmount" required min="0" step="0.01">
          </div>
          <div class="form-group">
            <label>类别</label>
            <select class="form-control" id="editTransactionCategory" required>
              <!-- Categories will be populated dynamically -->
            </select>
          </div>
          <div class="form-group">
            <label>日期</label>
            <input type="date" class="form-control" id="editTransactionDate" required>
          </div>
          <div class="form-group">
            <label>备注</label>
            <textarea class="form-control" id="editTransactionNote"></textarea>
          </div>
          <button type="submit" class="btn btn-primary">保存更改</button>
        </form>
      </div>
    </div>

  </div>
</div>

<script>
// Prevent default drag behaviors
function preventDefaults(e) {
  e.preventDefault();
  e.stopPropagation();
}

// Highlight drop zone when item is dragged over it
function highlight(e) {
  const dropZone = document.getElementById('logisticsImage').parentElement;
  dropZone.style.backgroundColor = '#e3f2fd';
  dropZone.style.borderColor = '#2196f3';
}

// Remove highlight from drop zone
function unhighlight(e) {
  const dropZone = document.getElementById('logisticsImage').parentElement;
  dropZone.style.backgroundColor = '#fafafa';
  dropZone.style.borderColor = '#ccc';
}

// Handle dropped files
function handleDrop(e) {
  const dt = e.dataTransfer;
  const files = dt.files;
  
  if (files && files.length > 0) {
    const file = files[0];
    if (file.type.startsWith('image/')) {
      const fileInput = document.getElementById('logisticsImage');
      fileInput.files = files;
      handleImageUpload({ target: fileInput });
    }
  }
}

function toggleCollapsibleContent(element) {
  const content = element.nextElementSibling;

  if (!content) return;

  if (content.style.display === 'block') {
    content.style.display = 'none';
    element.querySelector('span:last-child').textContent = '+';
  } else {
    content.style.display = 'block';
    element.querySelector('span:last-child').textContent = '-';
  }
}

function getFieldLabel(key) {
  const labels = {
    trackingNumber: '快递单号',
    recipient: '收件人',
    phone: '联系电话', 
    address: '收货地址'
  };
  return labels[key] || key;
}

function updateLogisticsStatus(id, newStatus) {
  const logisticsItem = logisticsData.find(item => item.id === parseInt(id));
  
  if (!logisticsItem) {
    console.error('Logistics item not found');
    return;
  }

  logisticsItem.status = newStatus;

  const statusMessages = {
    transit: '订单已更新为运输中状态',
    delivered: '订单已更新为已送达状态'
  };

  const messageDiv = document.createElement('div');
  messageDiv.style.position = 'fixed';
  messageDiv.style.top = '20px';
  messageDiv.style.left = '50%';
  messageDiv.style.transform = 'translateX(-50%)';
  messageDiv.style.backgroundColor = '#d4edda';
  messageDiv.style.color = '#155724';
  messageDiv.style.padding = '1rem 2rem';
  messageDiv.style.borderRadius = '4px';
  messageDiv.style.boxShadow = '0 2px 6px rgba(0,0,0,0.2)';
  messageDiv.style.zIndex = '1000';
  messageDiv.textContent = statusMessages[newStatus];

  document.body.appendChild(messageDiv);

  setTimeout(() => {
    messageDiv.remove();
  }, 3000);

  renderLogistics();
}

function renderLogistics() {
  const pendingContainer = document.getElementById('pendingShipments');
  const transitContainer = document.getElementById('inTransitShipments');
  const deliveredContainer = document.getElementById('deliveredShipments');

  pendingContainer.innerHTML = '';
  transitContainer.innerHTML = '';
  deliveredContainer.innerHTML = '';

  logisticsData.sort((a, b) => new Date(b.date) - new Date(a.date));

  logisticsData.forEach(item => {
    const element = document.createElement('div');
    element.className = 'logistics-item';
    
    const statusClass = 
      item.status === 'pending' ? 'status-pending' :
      item.status === 'transit' ? 'status-transit' :
      'status-delivered';
    
    const statusText = 
      item.status === 'pending' ? '待发货' :
      item.status === 'transit' ? '运输中' :
      '已送达';

    const actions = item.status === 'delivered' ? '' : `
      ${item.status === 'pending' ? 
        `<button class="btn btn-small btn-primary" onclick="updateLogisticsStatus(${item.id}, 'transit')">开始发货</button>` : 
        `<button class="btn btn-small btn-primary" onclick="updateLogisticsStatus(${item.id}, 'delivered')">确认送达</button>`
      }
      <button class="btn btn-small btn-danger" onclick="deleteLogistics(${item.id})">删除</button>
    `;

    element.innerHTML = `
      <div>
        <div>${formatDate(item.date)}</div>
        <small style="margin-top: 5px;">订单号: ${item.orderNumber}</small>
        <small>物流公司: ${getLogisticsCompanyName(item.company)}</small>
      </div>
      <div>
        <div>${item.product} × ${item.quantity}</div>
        <small>收件人: ${item.recipient}</small>
        <small>联系方式: ${item.contact}</small>
        <small>地址: ${item.address}</small>
      </div>
      <div>
        <span class="status-badge ${statusClass}">${statusText}</span>
      </div>
      <div class="logistics-actions">
        ${actions}
      </div>
    `;

    if (item.status === 'pending') {
      pendingContainer.appendChild(element);
    } else if (item.status === 'transit') {
      transitContainer.appendChild(element);
    } else {
      deliveredContainer.appendChild(element);
    }
  });
}

function getLogisticsCompanyName(code) {
  const companies = {
    'SF': '顺丰快递',
    'YT': '圆通快递',
    'ZT': '中通快递',
    'YD': '韵达快递',
    'ST': '申通快递',
    'EMS': 'EMS',
    'JD': '京东快递'
  };
  return companies[code] || code;
}

function deleteLogistics(id) {
  if (confirm('确定要删除该物流订单吗？')) {
    logisticsData = logisticsData.filter(item => item.id !== id);
    renderLogistics();
  }
}

function generateTrackingNumber() {
  const prefix = ['SF', 'YT', 'ZT', 'YD'][Math.floor(Math.random() * 4)];
  const numbers = Array.from({length: 12}, () => Math.floor(Math.random() * 10)).join('');
  return `${prefix}${numbers}`;
}

function simulateRecognizedName() {
  const surnames = ['张', '李', '王', '刘', '陈', '杨', '赵', '黄', '周', '吴'];
  const names = ['明', '华', '建', '强', '伟', '军', '芳', '娜', '英', '静'];
  return surnames[Math.floor(Math.random() * surnames.length)] + 
         names[Math.floor(Math.random() * names.length)];
}

function simulatePhoneNumber() {
  const prefixes = ['130', '131', '132', '133', '134', '135', '136', '137', '138', '139'];
  const prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
  const numbers = Array.from({length: 8}, () => Math.floor(Math.random() * 10)).join('');
  return `${prefix}${numbers}`;
}

function simulateAddress() {
  const provinces = ['北京市', '上海市', '广东省', '江苏省', '浙江省'];
  const cities = ['朝阳区', '浦东新区', '广州市', '南京市', '杭州市'];
  const streets = ['中山路', '解放路', '人民路', '建设路', '和平路'];
  
  const province = provinces[Math.floor(Math.random() * provinces.length)];
  const city = cities[Math.floor(Math.random() * cities.length)];
  const street = streets[Math.floor(Math.random() * streets.length)];
  const number = Math.floor(Math.random() * 200) + 1;
  
  return `${province}${city}${street}${number}号`;
}

function updateCategoryOptions() {
  const transactionType = document.getElementById('transactionType');
  const categorySelect = document.getElementById('transactionCategory');
  
  categorySelect.innerHTML = '';
  
  if (transactionType.value === 'income') {
    const incomeCategories = [
      { value: 'salary', label: '工资' },
      { value: 'offline', label: '线下订单' },
      { value: 'online', label: '线上订单' },
      { value: 'other', label: '其他' }
    ];
    
    incomeCategories.forEach(category => {
      const option = document.createElement('option');
      option.value = category.value;
      option.textContent = category.label;
      categorySelect.appendChild(option);
    });
  } else {
    const expenseCategories = [
      { value: 'transportation', label: '交通' },
      { value: 'purchase', label: '进货' },
      { value: 'other', label: '其他' }
    ];
    
    expenseCategories.forEach(category => {
      const option = document.createElement('option');
      option.value = category.value;
      option.textContent = category.label;
      categorySelect.appendChild(option);
    });
  }
}

let trendChart;

// Sample logistics data
let logisticsData = [
  {
    id: 1,
    company: 'SF',
    orderNumber: "L2023101",
    product: "唐肽燃",
    quantity: 100,
    status: "pending",
    recipient: "张三",
    contact: "13800138000",
    address: "北京市朝阳区xxx街道",
    date: "2023-10-15"
  },
  {
    id: 2, 
    company: 'YT',
    orderNumber: "L2023102",
    product: "唐肽燃",
    quantity: 50,
    status: "transit",
    recipient: "李四",
    contact: "13900139000", 
    address: "上海市浦东新区xxx路",
    date: "2023-10-16"
  }
];

// Mock inventory data
let inventoryData = [
  {
    id: 1,
    name: '唐肽燃',
    quantity: 500,
    unit: '盒',
    location: '主仓库A区',
    status: 'normal'
  },
  {
    id: 2,
    name: '唐肽燃',
    quantity: 50,
    unit: '盒', 
    location: '主仓库B区',
    status: 'low'
  }
];

// Initialize the trend chart
function initializeExpenseChart() {
  if (trendChart) {
    trendChart.destroy();
  }
  
  const trendCtx = document.getElementById('trendChart').getContext('2d');
  trendChart = new Chart(trendCtx, {
    type: 'line',
    data: {
      labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
      datasets: [{
        label: '收入',
        data: [22000, 23000, 24500, 25800, 25000, 25800],
        borderColor: '#2ecc71',
        tension: 0.4,
        fill: false
      }, {
        label: '支出',
        data: [12000, 15000, 13500, 15200, 14800, 15200],
        borderColor: '#e74c3c',
        tension: 0.4,
        fill: false
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'top',
        },
        title: {
          display: true,
          text: '收支对比趋势'
        }
      }
    }
  });
}

// Update dashboard based on selected time range
function updateDashboard() {
  const timeRange = document.getElementById('timeRangeFilter').value;
  updateStats(timeRange);
  updateCharts(timeRange);
}

// Update dashboard statistics
function updateStats(timeRange) {
  let stats = getStatsForRange(timeRange);
  
  document.getElementById('totalAssets').textContent = formatCurrency(stats.assets);
  document.getElementById('totalExpense').textContent = formatCurrency(stats.expense);
  document.getElementById('totalIncome').textContent = formatCurrency(stats.income);
  document.getElementById('netIncome').textContent = formatCurrency(stats.netIncome);
  
  document.getElementById('assetChange').textContent = `${stats.assetChange}% ${stats.assetChange >= 0 ? '↑' : '↓'}`;
  document.getElementById('expenseChange').textContent = `${stats.expenseChange}% ${stats.expenseChange >= 0 ? '↑' : '↓'}`;
  document.getElementById('incomeChange').textContent = `${stats.incomeChange}% ${stats.incomeChange >= 0 ? '↑' : '↓'}`;
  document.getElementById('netIncomeChange').textContent = `${stats.netIncomeChange}% ${stats.netIncomeChange >= 0 ? '↑' : '↓'}`;
}

// Get statistics for the selected time range
function getStatsForRange(timeRange) {
    const now = new Date();
    let startDate, endDate;
    
    switch(timeRange) {
        case 'month':
            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            break;
        case 'quarter':
            startDate = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
            endDate = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3 + 3, 0);
            break;
        case 'year':
            startDate = new Date(now.getFullYear(), 0, 1);
            endDate = new Date(now.getFullYear(), 11, 31);
            break;
    }

    const periodTransactions = transactions.filter(t => {
        const tDate = new Date(t.date);
        return tDate >= startDate && tDate <= endDate;
    });

    const income = periodTransactions
        .filter(t => t.type === 'income')
        .reduce((sum, t) => sum + t.amount, 0);
        
    const expense = periodTransactions
        .filter(t => t.type === 'expense')
        .reduce((sum, t) => sum + t.amount, 0);

    const netIncome = income - expense;
    const assets = income - expense + 100000;

    const prevStartDate = new Date(startDate);
    const prevEndDate = new Date(endDate);
    prevStartDate.setMonth(prevStartDate.getMonth() - 1);
    prevEndDate.setMonth(prevEndDate.getMonth() - 1);

    const prevTransactions = transactions.filter(t => {
        const tDate = new Date(t.date);
        return tDate >= prevStartDate && tDate <= prevEndDate;
    });

    const prevIncome = prevTransactions
        .filter(t => t.type === 'income')
        .reduce((sum, t) => sum + t.amount, 0);
        
    const prevExpense = prevTransactions
        .filter(t => t.type === 'expense')
        .reduce((sum, t) => sum + t.amount, 0);

    const prevNetIncome = prevIncome - prevExpense;
    const prevAssets = prevIncome - prevExpense + 100000;

    return {
        assets: assets,
        expense: expense,
        income: income,
        netIncome: netIncome,
        assetChange: prevAssets ? ((assets - prevAssets) / prevAssets * 100).toFixed(1) : 0,
        expenseChange: prevExpense ? ((expense - prevExpense) / prevExpense * 100).toFixed(1) : 0,
        incomeChange: prevIncome ? ((income - prevIncome) / prevIncome * 100).toFixed(1) : 0,
        netIncomeChange: prevNetIncome ? ((netIncome - prevNetIncome) / prevNetIncome * 100).toFixed(1) : 0
    };
}

// Update dashboard charts
function updateCharts(timeRange) {
  const chartData = getChartDataForRange(timeRange);
  
  trendChart.data.labels = chartData.labels;
  trendChart.data.datasets[0].data = chartData.incomes;
  trendChart.data.datasets[1].data = chartData.expenses;
  trendChart.update();
}

// Get chart data for the selected time range
function getChartDataForRange(timeRange) {
    const now = new Date();
    let labels = [];
    let incomes = [];
    let expenses = [];

    switch(timeRange) {
        case 'month':
            for(let i = 0; i < 4; i++) {
                const weekStart = new Date(now.getFullYear(), now.getMonth(), 1 + (i * 7));
                const weekEnd = new Date(now.getFullYear(), now.getMonth(), 7 + (i * 7));
                
                labels.push(`第${i+1}周`);
                
                const weekIncome = transactions
                    .filter(t => {
                        const date = new Date(t.date);
                        return date >= weekStart && date <= weekEnd && t.type === 'income';
                    })
                    .reduce((sum, t) => sum + t.amount, 0);
                    
                const weekExpense = transactions
                    .filter(t => {
                        const date = new Date(t.date);
                        return date >= weekStart && date <= weekEnd && t.type === 'expense';
                    })
                    .reduce((sum, t) => sum + t.amount, 0);
                
                incomes.push(weekIncome);
                expenses.push(weekExpense);
            }
            break;

        case 'quarter':
            const quarterStart = Math.floor(now.getMonth() / 3) * 3;
            for(let i = 0; i < 3; i++) {
                const monthStart = new Date(now.getFullYear(), quarterStart + i, 1);
                const monthEnd = new Date(now.getFullYear(), quarterStart + i + 1, 0);
                
                labels.push(`${quarterStart + i + 1}月`);
                
                const monthIncome = transactions
                    .filter(t => {
                        const date = new Date(t.date);
                        return date >= monthStart && date <= monthEnd && t.type === 'income';
                    })
                    .reduce((sum, t) => sum + t.amount, 0);
                    
                const monthExpense = transactions
                    .filter(t => {
                        const date = new Date(t.date);
                        return date >= monthStart && date <= monthEnd && t.type === 'expense';
                    })
                    .reduce((sum, t) => sum + t.amount, 0);
                
                incomes.push(monthIncome);
                expenses.push(monthExpense);
            }
            break;

        case 'year':
            for(let i = 0; i < 4; i++) {
                const quarterStartDate = new Date(now.getFullYear(), i * 3, 1);
                const quarterEndDate = new Date(now.getFullYear(), (i + 1) * 3, 0);
                
                labels.push(`${i+1}季度`);
                
                const quarterIncome = transactions
                    .filter(t => {
                        const date = new Date(t.date);
                        return date >= quarterStartDate && date <= quarterEndDate && t.type === 'income';
                    })
                    .reduce((sum, t) => sum + t.amount, 0);
                    
                const quarterExpense = transactions
                    .filter(t => {
                        const date = new Date(t.date);
                        return date >= quarterStartDate && date <= quarterEndDate && t.type === 'expense';
                    })
                    .reduce((sum, t) => sum + t.amount, 0);
                
                incomes.push(quarterIncome);
                expenses.push(quarterExpense);
            }
            break;
    }

    return {
        labels,
        incomes,
        expenses
    };
}

// 模拟交易数据
let transactions = [
    {
        id: 1,
        date: '2023-10-01',
        type: 'income',
        category: 'salary',
        amount: 15000,
        note: '月薪'
    },
    {
        id: 2,
        date: '2023-10-02',
        type: 'expense',
        category: 'food',
        amount: 100,
        note: '午餐'
    }
];

// 交易过滤函数
function filterTransactions() {
  const startDate = document.getElementById('filterStartDate').value;
  const endDate = document.getElementById('filterEndDate').value;
  
  if (!startDate || !endDate) {
    alert('请选择开始和结束日期');
    return;
  }

  const start = new Date(startDate);
  const end = new Date(endDate);
  end.setHours(23, 59, 59);

  const filteredTransactions = transactions.filter(t => {
    const tDate = new Date(t.date);
    return tDate >= start && tDate <= end;
  });

  renderFilteredTransactions(filteredTransactions);
  renderFilteredSummary(filteredTransactions);
}

// 重置过滤器
function resetFilters() {
  document.getElementById('filterStartDate').value = '';
  document.getElementById('filterEndDate').value = '';
  renderTransactions();
  renderTransactionSummary();
}

// 渲染过滤后的交易记录
function renderFilteredTransactions(filteredTransactions) {
  const transactionsList = document.getElementById('transactionsList');
  transactionsList.innerHTML = '';

  filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));

  filteredTransactions.forEach(transaction => {
    const element = document.createElement('div');
    element.className = 'transaction-item';
    element.innerHTML = `
      <div>${formatDate(transaction.date)}</div>
      <div>${transaction.type === 'income' ? '收入' : '支出'}</div>
      <div>
        ${getCategoryName(transaction.category)}
        ${transaction.note ? `<div class="transaction-note">${transaction.note}</div>` : ''}
      </div>
      <div class="transaction-amount ${transaction.type}">
        ${formatCurrency(transaction.amount)}
      </div>
      <div class="transaction-actions">
        <button class="btn btn-small btn-warning" onclick="editTransaction(${transaction.id})">编辑</button>
        <button class="btn btn-small btn-danger" onclick="deleteTransaction(${transaction.id})">删除</button>
      </div>
    `;
    transactionsList.appendChild(element);
  });
}

// 渲染过滤后的统计信息
function renderFilteredSummary(filteredTransactions) {
  const summary = {
    monthlyIncome: filteredTransactions
      .filter(t => t.type === 'income')
      .reduce((sum, t) => sum + t.amount, 0),
    monthlyExpense: filteredTransactions
      .filter(t => t.type === 'expense')
      .reduce((sum, t) => sum + t.amount, 0),
  };
  summary.monthlyNet = summary.monthlyIncome - summary.monthlyExpense;

  const existingSummary = document.querySelector('.transaction-summary');
  if (existingSummary) {
    existingSummary.remove();
  }

  const summaryHTML = `
    <div class="transaction-summary">
      <div class="summary-card">
        <h4>收入</h4>
        <div class="summary-value" style="color: var(--success)">${formatCurrency(summary.monthlyIncome)}</div>
      </div>
      <div class="summary-card">
        <h4>支出</h4>
        <div class="summary-value" style="color: var(--danger)">${formatCurrency(summary.monthlyExpense)}</div>
      </div>
      <div class="summary-card">
        <h4>结余</h4>
        <div class="summary-value" style="color: ${summary.monthlyNet >= 0 ? 'var(--success)' : 'var(--danger)'}">${formatCurrency(summary.monthlyNet)}</div>
      </div>
    </div>
  `;
  
  const container = document.querySelector('.transactions-container');
  container.insertAdjacentHTML('afterbegin', summaryHTML);
}

// 页面导航函数
function showDashboard() {
    hideAllSections();
    document.getElementById('dashboard').style.display = 'block';
}

function showTransactions() {
    hideAllSections();
    document.getElementById('transactions').style.display = 'block';
    renderTransactions();
    renderTransactionSummary();
}

function showBudget() {
    hideAllSections();
    document.getElementById('budget').style.display = 'block';
    renderBudgets();
    updateBudgetOverview();
}

function showLogistics() {
    hideAllSections();
    document.getElementById('logistics').style.display = 'block';
    renderLogistics();
}

function showInventory() {
    hideAllSections();
    document.getElementById('inventory').style.display = 'block';
    renderInventory();
}

function hideAllSections() {
    document.getElementById('dashboard').style.display = 'none';
    document.getElementById('transactions').style.display = 'none';
    document.getElementById('budget').style.display = 'none';
    document.getElementById('logistics').style.display = 'none';
    document.getElementById('inventory').style.display = 'none';
}

// 初始化报表页面
function initializeReports() {
    const now = new Date();
    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
    const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
    
    document.getElementById('startDate').value = firstDay.toISOString().split('T')[0];
    document.getElementById('endDate').value = lastDay.toISOString().split('T')[0];
    
    generateReport(new Event('submit'));
}

// 处理添加新交易
function handleAddTransaction(event) {
    event.preventDefault();
    
    const type = document.getElementById('transactionType').value;
    const amount = parseFloat(document.getElementById('transactionAmount').value);
    const category = document.getElementById('transactionCategory').value;
    const date = document.getElementById('transactionDate').value;
    const note = document.getElementById('transactionNote').value;

    const newTransaction = {
        id: transactions.length + 1,
        date,
        type,
        category,
        amount,
        note
    };

    transactions.push(newTransaction);
    renderTransactions();
    renderTransactionSummary();
    
    updateDashboard();
    event.target.reset();
}

// Declare a variable to hold the current transaction being edited
let editedTransactionId = null;

// Open the edit modal and populate with transaction details
function editTransaction(id) {
  const transaction = transactions.find(t => t.id === id);
  if (!transaction) return;

  editedTransactionId = id; // Store the transaction ID being edited

  document.getElementById('editTransactionType').value = transaction.type;
  document.getElementById('editTransactionAmount').value = transaction.amount;
  document.getElementById('editTransactionDate').value = transaction.date;
  document.getElementById('editTransactionNote').value = transaction.note;

  // Populate categories based on transaction type
  updateEditCategoryOptions(transaction.type);
  document.getElementById('editTransactionCategory').value = transaction.category;

  // Display the modal
  document.getElementById('editTransactionModal').style.display = 'block';
}

// Handle the editing process
function handleEditTransaction(event) {
  event.preventDefault();

  const type = document.getElementById('editTransactionType').value;
  const amount = parseFloat(document.getElementById('editTransactionAmount').value);
  const category = document.getElementById('editTransactionCategory').value;
  const date = document.getElementById('editTransactionDate').value;
  const note = document.getElementById('editTransactionNote').value;

  const transactionIndex = transactions.findIndex(t => t.id === editedTransactionId);
  if (transactionIndex !== -1) {
    transactions[transactionIndex] = {
      id: editedTransactionId,
      date,
      type,
      category,
      amount,
      note
    };

    // Re-render transactions and summary
    renderTransactions();
    renderTransactionSummary();
    updateDashboard(); // Sync the dashboard

    // Close the modal
    closeEditModal();
  }
}

// Close the modal
function closeEditModal() {
  document.getElementById('editTransactionModal').style.display = 'none';
  editedTransactionId = null;
}

// Update category options in the edit form based on transaction type
function updateEditCategoryOptions(type) {
  const categorySelect = document.getElementById('editTransactionCategory');
  categorySelect.innerHTML = '';

  const categories = type === 'income' ? [
    { value: 'salary', label: '工资' },
    { value: 'offline', label: '线下订单' },
    { value: 'online', label: '线上订单' },
    { value: 'other', label: '其他' }
  ] : [
    { value: 'transportation', label: '交通' },
    { value: 'purchase', label: '进货' },
    { value: 'other', label: '其他' }
  ];

  categories.forEach(category => {
    const option = document.createElement('option');
    option.value = category.value;
    option.textContent = category.label;
    categorySelect.appendChild(option);
  });
}

// Add event listener to dynamically update category options
document.getElementById('editTransactionType').addEventListener('change', (e) => {
  updateEditCategoryOptions(e.target.value);
});

function renderTransactionSummary() {
  const existingSummary = document.querySelector('.transaction-summary');
  if (existingSummary) {
    existingSummary.remove();
  }

  const summary = calculateTransactionSummary();
  
  const summaryHTML = `
    <div class="transaction-summary">
      <div class="summary-card">
        <h4>本月收入</h4>
        <div class="summary-value" style="color: var(--success)">${formatCurrency(summary.monthlyIncome)}</div>
      </div>
      <div class="summary-card">
        <h4>本月支出</h4>
        <div class="summary-value" style="color: var(--danger)">${formatCurrency(summary.monthlyExpense)}</div>
      </div>
      <div class="summary-card">
        <h4>本月结余</h4>
        <div class="summary-value" style="color: ${summary.monthlyNet >= 0 ? 'var(--success)' : 'var(--danger)'}">${formatCurrency(summary.monthlyNet)}</div>
      </div>
    </div>
  `;
  
  const container = document.querySelector('.transactions-container');
  container.insertAdjacentHTML('afterbegin', summaryHTML);
}

// 计算交易概况
function calculateTransactionSummary() {
  const now = new Date();
  const thisMonth = transactions.filter(t => {
    const tDate = new Date(t.date);
    return tDate.getMonth() === now.getMonth() && 
           tDate.getFullYear() === now.getFullYear();
  });
  
  const monthlyIncome = thisMonth
    .filter(t => t.type === 'income')
    .reduce((sum, t) => sum + t.amount, 0);
    
  const monthlyExpense = thisMonth
    .filter(t => t.type === 'expense')
    .reduce((sum, t) => sum + t.amount, 0);
    
  return {
    monthlyIncome,
    monthlyExpense,
    monthlyNet: monthlyIncome - monthlyExpense
  };
}

// 删除交易
function deleteTransaction(id) {
    if (confirm('确定要删除这条交易记录吗？')) {
        transactions = transactions.filter(t => t.id !== id);
        renderTransactions();
        renderTransactionSummary();
        
        updateDashboard();
    }
}

// 更新交易列表渲染
function renderTransactions() {
  const transactionsList = document.getElementById('transactionsList');
  transactionsList.innerHTML = '';

  transactions.sort((a, b) => new Date(b.date) - new Date(a.date));

  transactions.forEach(transaction => {
    const element = document.createElement('div');
    element.className = 'transaction-item';
    element.innerHTML = `
      <div>${formatDate(transaction.date)}</div>
      <div>${transaction.type === 'income' ? '收入' : '支出'}</div>
      <div>
        ${getCategoryName(transaction.category)}
        ${transaction.note ? `<div class="transaction-note">${transaction.note}</div>` : ''}
      </div>
      <div class="transaction-amount ${transaction.type}">
        ${formatCurrency(transaction.amount)}
      </div>
      <div class="transaction-actions">
        <button class="btn btn-small btn-warning" onclick="editTransaction(${transaction.id})">编辑</button>
        <button class="btn btn-small btn-danger" onclick="deleteTransaction(${transaction.id})">删除</button>
      </div>
    `;
    transactionsList.appendChild(element);
  });
}

function formatDate(dateStr) {
  return new Date(dateStr).toLocaleDateString('zh-CN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit'
  });
}

// 获取类别名称
function getCategoryName(category) {
    const categoryMap = {
        salary: '工资',
        offline: '线下订单',
        online: '线上订单',
        transportation: '交通',
        purchase: '进货',
        other: '其他',
        food: '食物',
        shopping: '购物'
    };
    return categoryMap[category] || category;
}

// 格式化货币
function formatCurrency(amount) {
    return new Intl.NumberFormat('zh-CN', {
        style: 'currency',
        currency: 'CNY'
    }).format(amount);
}

// 添加预算管理相关代码
let budgets = [
  {
    category: 'food',
    amount: 3000,
    used: 1800
  },
  {
    category: 'transportation',
    amount: 1000,
    used: 600
  },
  {
    category: 'shopping',
    amount: 2000,
    used: 1500
  }
];

function handleAddBudget(event) {
  event.preventDefault();
  
  const category = document.getElementById('budgetCategory').value;
  const amount = parseFloat(document.getElementById('budgetAmount').value);

  const existingBudgetIndex = budgets.findIndex(b => b.category === category);
  
  if (existingBudgetIndex !== -1) {
    budgets[existingBudgetIndex].amount = amount;
  } else {
    budgets.push({
      category,
      amount,
      used: 0
    });
  }

  renderBudgets();
  updateBudgetOverview();
  event.target.reset();
}

function renderBudgets() {
  const budgetList = document.getElementById('budgetList');
  budgetList.innerHTML = '';

  budgets.forEach(budget => {
    const percentage = (budget.used / budget.amount) * 100;
    const status = percentage >= 90 ? 'danger' : percentage >= 70 ? 'warning' : '';

    const element = document.createElement('div');
    element.className = 'budget-category';
    element.innerHTML = `
      <div style="flex: 1;">
        <div style="display: flex; justify-content: space-between;">
          <strong>${getCategoryName(budget.category)}</strong>
          <span>${formatCurrency(budget.used)} / ${formatCurrency(budget.amount)}</span>
        </div>
        <div class="progress-bar">
          <div class="progress-bar-fill ${status}" style="width: ${percentage}%"></div>
        </div>
      </div>
      <div class="budget-actions">
        <button class="btn btn-small btn-warning" onclick="editBudget('${budget.category}')">编辑</button>
        <button class="btn btn-small btn-danger" onclick="deleteBudget('${budget.category}')">删除</button>
      </div>
    `;
    budgetList.appendChild(element);
  });
}

function updateBudgetOverview() {
  const totalBudget = budgets.reduce((sum, budget) => sum + budget.amount, 0);
  const usedBudget = budgets.reduce((sum, budget) => sum + budget.used, 0);
  const remainingBudget = totalBudget - usedBudget;

  document.getElementById('totalBudget').textContent = formatCurrency(totalBudget);
  document.getElementById('usedBudget').textContent = formatCurrency(usedBudget);
  document.getElementById('remainingBudget').textContent = formatCurrency(remainingBudget);
}

function editBudget(category) {
  const budget = budgets.find(b => b.category === category);
  if (!budget) return;

  document.getElementById('budgetCategory').value = category;
  document.getElementById('budgetAmount').value = budget.amount;
}

function deleteBudget(category) {
  if (confirm('确定要删除这个预算项目吗？')) {
    budgets = budgets.filter(b => b.category !== category);
    renderBudgets();
    updateBudgetOverview();
  }
}

// 显示资产分布弹窗
function showAssetDistribution() {
  const totalAssetsCard = document.querySelector('.stat-card');

  const existingPopup = document.querySelector('.asset-distribution-popup');
  if (existingPopup) {
    existingPopup.remove();
  }

  const popup = document.createElement('div');
  popup.className = 'asset-distribution-popup';
  
  popup.innerHTML = `
    <h4>资产分布</h4>
    <div style="margin: 10px 0;">
      <div style="display: flex; justify-content: space-between; margin: 5px 0;">
        <span>现金</span>
        <span>¥30,000 (23.3%)</span>
      </div>
      <div style="display: flex; justify-content: space-between; margin: 5px 0;">
        <span>银行账户</span>
        <span>¥60,000 (46.7%)</span>
      </div>
      <div style="display: flex; justify-content: space-between; margin: 5px 0;">
        <span>投资</span>
        <span>¥20,000 (15.6%)</span>
      </div>
      <div style="display: flex; justify-content: space-between; margin: 5px 0;">
        <span>其他</span>
        <span>¥18,500 (14.4%)</span>
      </div>
    </div>
  `;

  const rect = totalAssetsCard.getBoundingClientRect();
  popup.style.top = `${rect.bottom + window.scrollY + 10}px`;
  popup.style.left = `${rect.left + window.scrollX}px`;
  
  document.body.appendChild(popup);
  popup.style.display = 'block';
}

// Show expense details popup
function showExpenseDetails() {
  const expenseCard = document.querySelector('.stat-card:nth-child(2)');
  
  const existingPopup = document.querySelector('.expense-details-popup');
  if (existingPopup) {
    existingPopup.remove();
  }

  const now = new Date();
  const currentMonthExpenses = transactions.filter(t => {
    const tDate = new Date(t.date);
    return t.type === 'expense' && 
           tDate.getMonth() === now.getMonth() && 
           tDate.getFullYear() === now.getFullYear();
  });

  const expensesByCategory = currentMonthExpenses.reduce((acc, t) => {
    acc[t.category] = (acc[t.category] || 0) + t.amount;
    return acc;
  }, {});

  const totalExpense = currentMonthExpenses.reduce((sum, t) => sum + t.amount, 0);

  const popup = document.createElement('div');
  popup.className = 'expense-details-popup';
  
  let content = '<h4>支出明细</h4><div style="margin: 10px 0;">';
  
  for (const [category, amount] of Object.entries(expensesByCategory)) {
    const percentage = ((amount / totalExpense) * 100).toFixed(1);
    content += `
      <div style="display: flex; justify-content: space-between; margin: 5px 0;">
        <span>${getCategoryName(category)}</span>
        <span>${formatCurrency(amount)} (${percentage}%)</span>
      </div>
    `;
  }
  content += '</div>';
  popup.innerHTML = content;

  const rect = expenseCard.getBoundingClientRect();
  popup.style.top = `${rect.bottom + window.scrollY + 10}px`;
  popup.style.left = `${rect.left + window.scrollX}px`;
  
  document.body.appendChild(popup);
  popup.style.display = 'block';
}

// Show income details popup
function showIncomeDetails() {
  const incomeCard = document.querySelector('.stat-card:nth-child(3)');
  
  const existingPopup = document.querySelector('.income-details-popup');
  if (existingPopup) {
    existingPopup.remove();
  }

  const now = new Date();
  const currentMonthIncomes = transactions.filter(t => {
    const tDate = new Date(t.date);
    return t.type === 'income' && 
           tDate.getMonth() === now.getMonth() && 
           tDate.getFullYear() === now.getFullYear();
  });

  const incomesByCategory = currentMonthIncomes.reduce((acc, t) => {
    acc[t.category] = (acc[t.category] || 0) + t.amount;
    return acc;
  }, {});

  const totalIncome = currentMonthIncomes.reduce((sum, t) => sum + t.amount, 0);

  const popup = document.createElement('div');
  popup.className = 'income-details-popup';
  
  let content = '<h4>收入明细</h4><div style="margin: 10px 0;">';
  
  for (const [category, amount] of Object.entries(incomesByCategory)) {
    const percentage = ((amount / totalIncome) * 100).toFixed(1);
    content += `
      <div style="display: flex; justify-content: space-between; margin: 5px 0;">
        <span>${getCategoryName(category)}</span>
        <span>${formatCurrency(amount)} (${percentage}%)</span>
      </div>
    `;
  }
  content += '</div>';
  popup.innerHTML = content;

  const rect = incomeCard.getBoundingClientRect();
  popup.style.top = `${rect.bottom + window.scrollY + 10}px`;
  popup.style.left = `${rect.left + window.scrollX}px`;
  
  document.body.appendChild(popup);
  popup.style.display = 'block';
}

document.addEventListener('DOMContentLoaded', function() {
  const isLoggedIn = sessionStorage.getItem('isLoggedIn');
  
  if (isLoggedIn === 'true') {
    document.getElementById('loginPage').style.display = 'none';
    document.querySelector('.container').style.display = 'grid';
  } else {
    document.getElementById('loginPage').style.display = 'flex';
    document.querySelector('.container').style.display = 'none';
  }
  
  // Initialize other components
  initializeExpenseChart();
  showDashboard();
  renderBudgets();
  updateBudgetOverview();
  updateDashboard();
  
  // Initialize event listeners
  const totalAssetsCard = document.querySelector('.stat-card');
  totalAssetsCard.addEventListener('mouseenter', showAssetDistribution);
  totalAssetsCard.addEventListener('mouseleave', function() {
    const popup = document.querySelector('.asset-distribution-popup');
    if (popup) {
      popup.remove();
    }
  });
  
  const expenseCard = document.querySelector('.stat-card:nth-child(2)');
  expenseCard.addEventListener('mouseenter', showExpenseDetails);
  expenseCard.addEventListener('mouseleave', function() {
    const popup = document.querySelector('.expense-details-popup');
    if (popup) {
      popup.remove();
    }
  });

  const incomeCard = document.querySelector('.stat-card:nth-child(3)');  
  incomeCard.addEventListener('mouseenter', showIncomeDetails);
  incomeCard.addEventListener('mouseleave', function() {
    const popup = document.querySelector('.income-details-popup');
    if (popup) {
      popup.remove();
    }
  });
  
  document.addEventListener('click', function() {
    const popups = document.querySelectorAll('.asset-distribution-popup, .expense-details-popup, .income-details-popup');
    popups.forEach(popup => popup.remove());
  });

  const dropZone = document.getElementById('logisticsImage').parentElement;
  
  dropZone.style.position = 'relative';
  dropZone.style.border = '2px dashed #ccc';
  dropZone.style.borderRadius = '4px';
  dropZone.style.padding = '20px';
  dropZone.style.textAlign = 'center';
  dropZone.style.backgroundColor = '#fafafa';
  dropZone.style.cursor = 'pointer';
  
  const dropText = document.createElement('div');
  dropText.textContent = '拖拽图片到此处或点击上传';
  dropText.style.color = '#666';
  dropText.style.marginTop = '10px';
  dropZone.appendChild(dropText);

  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, false);
    document.body.addEventListener(eventName, preventDefaults, false);
  });

  ['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, highlight, false);
  });

  ['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, unhighlight, false);
  });

  dropZone.addEventListener('drop', handleDrop, false);
});

// New function to handle logout
function logout() {
  // Remove the logged in state from session storage
  sessionStorage.removeItem('isLoggedIn');

  // Hide the main container and show login page
  document.getElementById('loginPage').style.display = 'flex';
  document.querySelector('.container').style.display = 'none';
}

// Add this function to handle login
function handleLogin(event) {
  event.preventDefault();
  
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;

  if (username === 'admin' && password === 'admin') {
    // Set logged in state
    sessionStorage.setItem('isLoggedIn', 'true');
    
    // Show main content and hide login page
    document.getElementById('loginPage').style.display = 'none';
    document.querySelector('.container').style.display = 'grid';
    
    // Reset form
    event.target.reset();
    
    // Initialize dashboard
    initializeExpenseChart();
    showDashboard();
    renderBudgets();
    updateBudgetOverview();
    updateDashboard();
  } else {
    alert('用户名或密码错误');
  }
}

// Function to handle adding logistics information
function handleAddLogistics(event) {
  event.preventDefault();
  
  const company = document.getElementById('logisticsCompany').value;
  const orderNumber = document.getElementById('orderNumber').value;
  const product = document.getElementById('logisticsProduct').value;
  const quantity = parseInt(document.getElementById('logisticsQuantity').value);
  const status = document.getElementById('logisticsStatus').value;
  const recipient = document.getElementById('logisticsRecipient').value;
  const contact = document.getElementById('logisticsContact').value;
  const address = document.getElementById('logisticsAddress').value;
  const date = document.getElementById('logisticsDate').value;

  const newLogistics = {
    id: logisticsData.length + 1,
    company,
    orderNumber,
    product,
    quantity,
    status,
    recipient,
    contact,
    address,
    date
  };

  logisticsData.push(newLogistics);
  renderLogistics();
  event.target.reset();
}

// Function to handle image upload for logistics
function handleImageUpload(event) {
  const file = event.target.files[0];
  if (!file) return;

  const previewContainer = document.getElementById('previewContainer');
  previewContainer.innerHTML = '';

  if (file.type.startsWith('image/')) {
    const img = document.createElement('img');
    img.style.maxWidth = '100%';
    img.style.height = 'auto';
    
    const reader = new FileReader();
    reader.onload = (e) => {
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
    
    previewContainer.appendChild(img);
  }
}

// Function to handle OCR recognition
function recognizeLogistics() {
  const imageInput = document.getElementById('logisticsImage');
  if (!imageInput.files || !imageInput.files[0]) {
    alert('请先上传图片');
    return;
  }

  const file = imageInput.files[0];
  Tesseract.recognize(
    file,
    'chi_sim',
    { logger: m => console.log(m) }
  ).then(({ data: { text } }) => {
    // Try to extract logistics information from the text
    const matches = {
      orderNumber: text.match(/\d{10,}/),
      recipient: text.match(/收件人[:：]?\s*([^\n]+)/),
      phone: text.match(/电话[:：]?\s*(\d{11})/),
      address: text.match(/地址[:：]?\s*([^\n]+)/)
    };

    // Fill in the form fields if matches are found
    Object.keys(matches).forEach(key => {
      if (matches[key]) {
        const value = matches[key][1] || matches[key][0];
        const input = document.getElementById(`logistics${key.charAt(0).toUpperCase() + key.slice(1)}`);
        if (input) {
          input.value = value;
        }
      }
    });
  });
}

// Function to render inventory
function renderInventory() {
  const inventoryList = document.getElementById('inventoryList');
  inventoryList.innerHTML = '';

  inventoryData.forEach(item => {
    const element = document.createElement('div');
    element.className = 'logistics-item';
    
    const statusClass = item.quantity <= 100 ? 'status-low' : 'status-normal';
    const statusText = item.quantity <= 100 ? '库存不足' : '库存充足';
    
    element.innerHTML = `
      <div>${item.name}</div>
      <div>
        数量: ${item.quantity} ${item.unit}<br>
        <small>存储位置: ${item.location}</small>
      </div>
      <div>
        <span class="status-badge ${statusClass}">${statusText}</span>
      </div>
      <div>
        <button class="btn btn-small btn-warning" onclick="editInventory(${item.id})">编辑</button>
        <button class="btn btn-small btn-danger" onclick="deleteInventory(${item.id})">删除</button>
      </div>
    `;
    
    inventoryList.appendChild(element);
  });
}

// Function to handle adding inventory
function handleAddInventory(event) {
  event.preventDefault();
  
  const name = document.getElementById('productName').value;
  const quantity = parseInt(document.getElementById('quantity').value);
  const unit = document.getElementById('unit').value;
  const location = document.getElementById('location').value;

  const newInventory = {
    id: inventoryData.length + 1,
    name,
    quantity,
    unit,
    location,
    status: quantity <= 100 ? 'low' : 'normal'
  };

  inventoryData.push(newInventory);
  renderInventory();
  event.target.reset();
}

// Functions to handle inventory editing and deletion
function editInventory(id) {
  const item = inventoryData.find(i => i.id === id);
  if (!item) return;

  document.getElementById('productName').value = item.name;
  document.getElementById('quantity').value = item.quantity;
  document.getElementById('unit').value = item.unit;
  document.getElementById('location').value = item.location;

  // Remove the old item - it will be replaced when form is submitted
  inventoryData = inventoryData.filter(i => i.id !== id);
}

function deleteInventory(id) {
  if (confirm('确定要删除这个库存项目吗？')) {
    inventoryData = inventoryData.filter(i => i.id !== id);
    renderInventory();
  }
}
</script>

</body></html>